# AICRM 项目结构

```
aicrm/
│
├── 📁 analyzers/                    # AI分析模块
│   ├── company_profile.py          # 企业画像构建
│   └── intent_score.py             # 客户意向评分
│
├── 📁 api/                          # API接口层
│   └── main.py                     # FastAPI主应用
│
├── 📁 config/                       # 配置模块
│   └── settings.py                 # 系统配置管理
│
├── 📁 docs/                         # 文档目录
│   ├── architecture.md             # 架构文档（待创建）
│   └── development.md              # 开发指南（待创建）
│
├── 📁 logs/                         # 日志目录
│   ├── aicrm.log                   # 主日志
│   ├── api.log                     # API日志
│   ├── crawler.log                 # 爬虫日志
│   └── celery.log                  # Celery日志
│
├── 📁 middleware/                   # 中间件模块
│   ├── anti_spider.py              # 反爬虫中间件
│   ├── captcha.py                  # 验证码处理
│   └── proxy.py                    # 代理池管理
│
├── 📁 spiders/                      # 爬虫模块
│   ├── base.py                     # 基础爬虫类
│   └── company_spider.py           # 企业信息爬虫
│
├── 📁 storage/                      # 数据存储模块
│   ├── database.py                 # 数据库操作
│   └── models.py                   # 数据模型定义
│
├── 📁 tests/                        # 测试模块
│   ├── test_analyzers/             # 分析器测试
│   ├── test_middleware/            # 中间件测试
│   └── test_api/                   # API测试
│
├── 📄 .env.example                  # 环境变量模板
├── 📄 .gitignore                    # Git忽略配置
├── 📄 DEPLOYMENT.md                 # 部署指南
├── 📄 Dockerfile                    # Docker镜像配置
├── 📄 PROJECT_SUMMARY.md            # 项目总结
├── 📄 README.md                     # 项目说明
├── 📄 docker-compose.yml            # Docker编排配置
├── 📄 requirements.txt              # Python依赖
└── 📄 start.sh                      # 一键启动脚本
```

---

## 核心模块说明

### 📊 analyzers/ - AI分析模块

| 文件 | 功能 | 主要类 |
|------|------|--------|
| `company_profile.py` | 企业画像构建 | `CompanyProfileBuilder`, `CompanyClusterAnalyzer` |
| `intent_score.py` | 客户意向评分 | `IntentScoreModel`, `IntentScore` |

### 🌐 api/ - API接口层

| 文件 | 功能 | 端点数 |
|------|------|--------|
| `main.py` | RESTful API服务 | 15+ |

### ⚙️ config/ - 配置模块

| 文件 | 功能 |
|------|------|
| `settings.py` | 统一配置管理，支持环境变量 |

### 🛡️ middleware/ - 中间件模块

| 文件 | 功能 | 主要类 |
|------|------|--------|
| `anti_spider.py` | 反爬虫策略 | `AntiSpiderMiddleware`, `ProxyMiddleware`, `CookieMiddleware`, `HeadersMiddleware` |
| `captcha.py` | 验证码识别 | `TesseractSolver`, `TwoCaptchaSolver`, `HybridSolver` |
| `proxy.py` | 代理池管理 | `ProxyPool`, `ProxyInfo` |

### 🕷️ spiders/ - 爬虫模块

| 文件 | 功能 | 主要类 |
|------|------|--------|
| `base.py` | 基础爬虫封装 | `BaseSpider`, `RetryMiddleware` |
| `company_spider.py` | 企业信息爬虫 | `CompanyInfoSpider`, `ContactInfoSpider` |

### 💾 storage/ - 数据存储模块

| 文件 | 功能 | 主要类 |
|------|------|--------|
| `database.py` | 数据库操作 | `DatabaseManager` |
| `models.py` | 数据模型 | `Company`, `Contact`, `Interaction`, `FinancialRecord` |

---

## 技术栈详情

### 后端框架

```
FastAPI
├── Pydantic (数据验证)
├── SQLAlchemy (ORM)
├── Uvicorn (ASGI服务器)
└── CORS中间件
```

### 数据存储

```
PostgreSQL 15          # 结构化数据
├── 企业信息
├── 联系人
├── 互动记录
└── 财务数据

MongoDB 7              # 非结构化数据
└── 原始HTML/爬虫数据

Elasticsearch 8        # 全文搜索
└── 企业搜索索引

Redis 7                # 缓存/消息队列
├── 任务队列
├── 缓存
└── Session存储
```

### 爬虫技术

```
Scrapy 2.11            # 爬虫框架
├── 中间件系统
├── 管道系统
└── 调度器

Playwright             # 动态页面
└── JS渲染支持
```

### AI/ML

```
Scikit-learn           # 机器学习
├── 聚类分析
├── 特征工程
└── 预处理

TensorFlow             # 深度学习（可选）

jieba                  # 中文分词
└── 关键词提取
```

### 任务队列

```
Celery 5.3             # 异步任务
├── Worker (任务执行)
├── Beat (定时任务)
└── Broker (Redis)
```

### 验证码识别

```
Tesseract OCR          # 本地识别
├── 图像预处理
└── 文字识别

2Captcha               # 人工打码
└── 高准确率识别
```

---

## 数据流图

```
┌─────────────┐
│  数据源     │
│  (网站)     │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────┐
│         爬虫层 (Spiders)             │
│  ┌──────────────────────────────┐   │
│  │ • 企业信息爬虫               │   │
│  │ • 联系人爬虫                 │   │
│  │ • 基础爬虫类                 │   │
│  └──────────────────────────────┘   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│       中间件层 (Middleware)          │
│  ┌──────────────────────────────┐   │
│  │ • 反爬虫中间件               │   │
│  │ • 代理池管理                 │   │
│  │ • 验证码识别                 │   │
│  │ • Cookie管理                 │   │
│  └──────────────────────────────┘   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│       存储层 (Storage)               │
│  ┌──────────┐  ┌────────────────┐   │
│  │PostgreSQL│  │    MongoDB     │   │
│  │ (结构化) │  │   (原始数据)   │   │
│  └──────────┘  └────────────────┘   │
│  ┌──────────────────────────────┐   │
│  │    Elasticsearch             │   │
│  │    (搜索索引)                │   │
│  └──────────────────────────────┘   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│       分析层 (Analyzers)             │
│  ┌──────────────────────────────┐   │
│  │ • 企业画像构建               │   │
│  │ • 客户意向评分               │   │
│  │ • 聚类分析                   │   │
│  └──────────────────────────────┘   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│       API层 (FastAPI)                │
│  ┌──────────────────────────────┐   │
│  │ • RESTful接口                │   │
│  │ • 认证授权                   │   │
│  │ • 数据验证                   │   │
│  └──────────────────────────────┘   │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│       前端层 (Frontend)              │
│  ┌──────────────────────────────┐   │
│  │ • 管理后台                   │   │
│  │ • 数据可视化                 │   │
│  │ • 客户360视图                │   │
│  └──────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## 部署架构

```
┌─────────────────────────────────────────┐
│            Nginx (反向代理)              │
│              :80 / :443                  │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│         API服务 (FastAPI)                │
│            :8000 (多Worker)              │
└─────────────────────────────────────────┘
                 │
    ┌────────────┼────────────┐
    ▼            ▼            ▼
┌────────┐  ┌─────────┐  ┌──────────┐
│Celery  │  │Celery   │  │  Scrapy  │
│Worker  │  │Beat     │  │  爬虫    │
└────────┘  └─────────┘  └──────────┘
    │            │
    └────┬───────┘
         ▼
┌─────────────────────────────────────────┐
│            Redis (消息队列/缓存)          │
└─────────────────────────────────────────┘
         │
    ┌────┼────┬─────────┬──────────┐
    ▼    ▼    ▼         ▼          ▼
┌──────┐ ┌──────┐ ┌──────────┐ ┌─────────┐
│PostgreSQL│MongoDB│Elasticsearch│  Redis  │
│  (主库) │ (文档)│  (搜索)   │ (缓存)  │
└────────┘ └──────┘ └──────────┘ └─────────┘
```

---

## 开发工作流

```bash
# 1. 环境准备
./start.sh install

# 2. 启动服务
./start.sh start

# 3. 查看日志
./start.sh logs

# 4. 运行测试
pytest tests/

# 5. 启动爬虫
scrapy crawl company_spider

# 6. 访问API
http://localhost:8000/docs
```

---

## 核心指标

| 指标 | 数值 |
|------|------|
| 总代码行数 | ~5000 |
| 核心模块数 | 10 |
| API接口数 | 15+ |
| 数据表数 | 4 |
| 中间件数 | 4 |
| 分析模型数 | 2 |
| 支持的验证码类型 | 5 |
| 反爬虫策略数 | 7 |

---

**最后更新**: 2025年1月
